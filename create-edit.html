<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <title>Create / Edit Student</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        label {
            font-weight: 500;
        }

        label::after {
            content: attr(data-required);
            color: red;
            margin-left: 2px;
        }
    </style>
</head>

<body class="p-4">
    <div class="container" style="max-width: 600px;">
        <h4 id="title" class="bg-secondary p-4 text-white rounded">Create Student</h4>
        <form id="studentForm" class="border border-2 p-3 rounded">
            <input type="hidden" id="studentId">
            <div class="mb-2"><label data-required="*">Name</label>
                <input id="name" class="form-control" required>
            </div>
            <div class="mb-2"><label data-required="*">Age</label><input id="age" type="number" class="form-control"
                    required></div>
            <div class="mb-2">
                <label data-required="*">Date of Birth</label>
                <input id="dob" type="date" class="form-control" required>
            </div>

            <div class="mb-2"><label>Address</label><textarea id="address" class="form-control"></textarea></div>
            <div class="mb-2">
                <label data-required="*">State</label>
                <div class="d-flex align-items-center">
                    <select id="stateSelect" class="form-select me-2" style="width: 387px;" required>
                        <option>-- Select State --</option>
                    </select>

                    <button type="button" id="addStateBtn" class="btn btn-info">
                        Save State Name
                    </button>
                </div>
            </div>

            <div class="mb-2"><label>Phone Number</label><input id="phone" class="form-control"></div>

            <div class="mb-3">
                <label>Photos (multiple)</label>
                <input id="photos" type="file" multiple accept="image/*" class="form-control">
                <!-- <small class="text-muted">Images will be compressed client-side (aim &lt;= 2KB each).</small> -->
            </div>

            <div class="mb-3">
                <label>Subjects</label>
                <table class="table" id="subjectsTable">
                    <thead>
                        <tr>
                            <th>Subject Name</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <button id="submitBtn" class="btn btn-primary">Submit</button>
        </form>
    </div>

    <!-- modal for state entry -->
    <div class="modal" tabindex="-1" id="stateModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add State</h5>
                </div>
                <div class="modal-body">
                    <input id="newStateName" class="form-control" placeholder="State Name">
                </div>
                <div class="modal-footer">
                    <button id="saveState" class="btn btn-primary">Save State</button>
                    <button id="closeState" class="btn btn-secondary">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- password modal for update -->
    <div class="modal" tabindex="-1" id="pwModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Enter Password to Update</h5>
                </div>
                <div class="modal-body"><input id="pwInput" type="password" class="form-control"></div>
                <div class="modal-footer">
                    <button id="pwConfirm" class="btn btn-primary">OK</button>
                    <button id="pwCancel" class="btn btn-secondary">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        (function authGuard() { if (!localStorage.getItem('token')) window.location.href = 'login.html'; })();
        const token = localStorage.getItem('token');

        const urlParams = new URLSearchParams(window.location.search);
        const editingId = urlParams.get('id');
        const BASE_URL = "http://localhost:8080";

        // load states
        function loadStates() {
            $.ajax({
                url: BASE_URL + "/api/states", headers: { Authorization: 'Bearer ' + token }, success: function (res) {
                    const select = $('#stateSelect').empty().append('<option value="">-- Select State --</option>');
                    res.forEach(s => select.append(`<option value="${s.id}">${s.name}</option>`));
                }
            });
        }

        loadStates();

        // Add state modal handlers
        $('#addStateBtn').on('click', () => $('#stateModal').show());
        $('#closeState').on('click', () => $('#stateModal').hide());
        $('#saveState').on('click', function () {
            const name = $('#newStateName').val().trim();
            if (!name) return;
            $.ajax({
                url: BASE_URL + "/api/states",
                method: 'POST',
                headers: { Authorization: 'Bearer ' + token, 'Content-Type': 'application/json' },
                data: JSON.stringify({ name }),
                success: function () { $('#stateModal').hide(); loadStates(); Swal.fire('Saved', 'State saved', 'success'); }
            });
        });

        // Add a subject row (value = filled or empty)
        function addSubjectRow(value = '', allowAddButton = false) {
            $('#subjectsTable tbody').append(`
        <tr>
            <td>
                <input type="text" class="form-control subjectInput" value="${value}">
            </td>
            <td>
                ${allowAddButton
                    ? `<button class="btn btn-primary btn-sm addSub">Add</button>`
                    : `<button class="btn btn-danger btn-sm removeSub">Delete</button>`
                }
            </td>
        </tr>
    `);
        }


        // EVENT: Add subject
        $(document).on('click', '.addSub', function () {
            let row = $(this).closest('tr');
            let val = row.find('.subjectInput').val().trim();

            if (val === "") {
                alert("Please enter subject name");
                return;
            }

            // Convert add row -> normal row
            row.find('td:eq(1)').html(`<button class="btn btn-danger btn-sm removeSub">Delete</button>`);

            // Always add ONLY one empty row with Add button
            addSubjectRow('', true);
        });


        // EVENT: Delete subject
        $(document).on('click', '.removeSub', function () {
            $(this).closest('tr').remove();
        });


        // Image compression helper (attempt)
        function compressImage(file, maxSizeKB, callback) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const img = new Image();
                img.onload = function () {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    // scale image down while keeping aspect ratio
                    let width = img.width, height = img.height;
                    const ratio = Math.sqrt((maxSizeKB * 1024) / (file.size || (width * height)));
                    if (ratio < 1) { width = Math.max(1, Math.floor(width * ratio)); height = Math.max(1, Math.floor(height * ratio)); }
                    canvas.width = width; canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);

                    // try decreasing quality until size satisfied or quality too low
                    (function tryQuality(q) {
                        canvas.toBlob(function (blob) {
                            if (blob.size <= maxSizeKB * 1024 || q < 0.2) {
                                callback(blob);
                            } else {
                                tryQuality(q - 0.1);
                            }
                        }, 'image/jpeg', q);
                    })(0.9);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // Submit create/update
        $('#studentForm').on('submit', function (e) {
            e.preventDefault();
            const phone = $('#phone').val().trim();
            const phoneRegex = /^\+91-\d{10}$/;

            if (phone && !phoneRegex.test(phone)) {
                Swal.fire('Invalid Phone', 'Phone number must be in the format +91-xxxxxxxxxx', 'error');
                return;
            }

            const form = new FormData();
            const name = $('#name').val();
            const age = $('#age').val();
            const dob = $('#dob').val();
            const address = $('#address').val();
            const stateId = $('#stateSelect').val() || '';
            // const phone = $('#phone').val();
            form.append('name', name);
            form.append('age', age);
            form.append('dob', document.getElementById("dob").value);
            form.append('address', address);
            form.append('stateId', stateId);
            form.append('phone', phone);

            // subjects
            $('.subjectInput').each(function () {
                const val = $(this).val().trim();
                if (val !== "") {
                    form.append('subjects', val);
                }
            });

            // photos: compress first, then append
            const files = $('#photos')[0].files;
            if (files.length === 0) {
                doSubmit(form);
            } else {
                // compress all then submit
                let processed = 0;
                for (let i = 0; i < files.length; i++) {
                    ((file) => {
                        compressImage(file, 2, function (blob) { // max 2KB
                            // name needed for backend
                            const newFile = new File([blob], file.name, { type: blob.type });
                            form.append('photos', newFile);
                            processed++;
                            if (processed === files.length) doSubmit(form);
                        });
                    })(files[i]);
                }
            }
        });

        function doSubmit(form) {
            if (editingId) {
                // ask password modal
                $('#pwModal').show();
                $('#pwConfirm').off('click').on('click', function () {
                    const pw = $('#pwInput').val();
                    if (pw !== '72991') {
                        Swal.fire('Wrong Password', '', 'error');
                        return;
                    }
                    $('#pwModal').hide(); sendUpdate(form);
                });
                $('#pwCancel').off('click').on('click', function () { $('#pwModal').hide(); });
            } else {
                // create
                $.ajax({
                    url: BASE_URL + "/api/students",
                    method: 'POST',
                    headers: { Authorization: 'Bearer ' + token },
                    processData: false,
                    contentType: false,
                    data: form,
                    success: function () { Swal.fire('Saved', 'Student created', 'success').then(() => window.location = 'index.html'); },
                    error: function (xhr) { Swal.fire('Error', 'Could not save', 'error'); }
                });
            }
        }

        function sendUpdate(form) {
            $.ajax({
                url: BASE_URL + "/api/students/" + editingId,
                method: 'PUT',
                headers: { Authorization: 'Bearer ' + token },
                processData: false,
                contentType: false,
                data: form,
                success: function () { Swal.fire('Updated', 'Student updated', 'success').then(() => window.location = 'index.html'); },
                error: function () { Swal.fire('Error updating', '', 'error'); }
            });
        }

        if (editingId) {
            $.ajax({
                url: BASE_URL + "/api/students/" + editingId,
                headers: { Authorization: 'Bearer ' + token },
                success: function (res) {
                    const master = res.master;

                    $('#name').val(master.name);
                    $('#age').val(master.age);
                    $('#dob').val(master.dob);
                    $('#address').val(master.address);
                    $('#phone').val(master.phone);
                    if (master.state_id) $('#stateSelect').val(master.state_id);

                    // Load ONLY real subjects
                    res.subjects.forEach(s => addSubjectRow(s.subject_name));

                    // Add ONLY one empty row with Add button
                    addSubjectRow('', true);
                }
            });
        } else {
            // Create mode â†’ One empty row only
            addSubjectRow('', true);
        }


    </script>
</body>

</html>